# ADS1256_NCU_V0_9C

### 已知問題
+ 手焊零件品質不佳，測試不易。
+ R5短路，造成LED燒毀。解決方式:POWER1的LED拔掉，R5拔掉。
  + 線路圖第一頁，LED區塊，POWER1的LED拔掉。R5拔掉。
+ L13~L16要接上
+ JP4接頭下一版本要改。

### 電源供應
+ 來源:
  + 選擇1: DC Jack(5V,2A,5V/1A,5V/0.5A)
  + 選擇2: USB2.0(CON1)。純Virtulcom版本韌體用這個來丟資料...
  + 選擇3: USB1.1(CON2)。
+ 上電燈號: 
  + SD卡槽旁邊的LED燈(SD_POWER1)會亮。這是硬體過電就亮，非韌體控制。
  + 韌體初始化成功就慢閃MCU旁的黃燈(LED_Y1)。MCU韌體控制，一秒一次。
  + 開始記錄時MCU旁的紅燈恆亮。

### GPS模組
+ 供電5V後模組才會啟動運行。
+ 鈕扣電池僅供維持RTC。
+ 上電後，GPS模組的USB接頭(Micro-B,Device only)可以連接電腦，僅用於除錯。支援熱拔插，隨時可移除。是Virtual COM port，請依照ublox原廠軟體連線。
  + https://www.u-blox.com/en/product/u-center
  + 因為使用M8系列GPS模組，Windows下請使用「u-center」軟體而非「u-center2」軟體。
  + 需要有ublox GPS模組使用的Virtual COM Driver，這是「u-center」軟體的預設安裝項目。
  + 可利用「u-center」軟體設定GPS模組的參數、檢驗狀態、更新韌體等。目前設定BaudRate=57600。
  + 已經有Virtual COM Driver的電腦，可以用「putty」等終端機軟體讀取GPS模組輸出文字。用來Debug。
  + 


### SD卡格式
+ 支援FAT32與exFAT，目前打算只使用exFAT來測試。最大容量試過256[GB]。


# 開發紀錄

### MCU開發板
https://www.nuvoton.com/products/iot-solution/iot-platform/numaker-pfm-m487/index.html



# 8U8D_100


### 產品壽命
+ GPS week number rollover:
  + 約19.6年發生一次，其計算week的二進位數值會溢位而回到0，這將影響產品的壽命。
  + GPS week number rollover第一次發生在1999年，第二次在2019年，下一次則是在2038年。
  + ublox公司的GPS採用業界常用的補償值設計，使GPS晶片延長溢位的發生時間。
  + 查閱晶片的韌體版本說明，會指出GPS week number的設定，對應可使用的年份。M8系列使用FW3.01時，約在2035年四月發生溢位。
    + REF: https://content.u-blox.com/sites/default/files/GNSS-FW3.01_ReleaseNotes_%28UBX-16000319%29_Public.pdf
    + REF: https://content.u-blox.com/sites/default/files/u-blox-GPS-WeekNumberRolloverWorkaround_IN_%28UBX-19039990%29.pdf
    + 依照ublox的說明，這僅影響年月日的顯示，並不影響時分秒的顯示，也不影響其他導航與時間脈衝功能。建議使用者針對此特色做相應準備。
  + 解決方案1: 如果原廠有提供韌體更新，應該還是可以延長時間壽命。
  + 解決方案2: 更新GPS晶片。
+ 2038年問題:
  + 2038年問題可能會導致某些軟體在2038年1月19日3時14分07秒之後無法正常工作。所有使用POSIX時間表示時間的程式都將受其影響。
  + 解決方案: 不要使用任何32bit的Time函數，改以GPS提供的時間戳搭配計數器(索引值)進行記錄。
    + 多數程式語言已經有替代函數出現，可用時間可包含0001年1月1日至9999年12月31日。MATLAB比較特別，是從一個不存在的0000年1月0日開始。這表示在電腦上後處理涵蓋了數千年內的使用範圍。
    + 規劃分索引值[min]:    
      + 1[hr]=60[min]
      + 1[day]=24[hr]=1440[minute]
      + 1[year]=365[day]=525600[sec]
      + 使用unsigned int型別，可使用於紀錄約8171年的時間長度。
    + 規劃秒索引值[sec]:
      + 1[min]=60[sec]
      + 1[hr]=60[min]=3,600[sec]
      + 1[day]=24[hr]=86,400[sec]
      + 1[year]=365[day]=31,536,000[sec]
      + 使用unsigned int型別，可使用於紀錄約136年的時間長度。
    + 如有必要則追加每秒第幾點索引值[index]
+ 耗電功率:
  + 規劃使用5[V]系統的電源。可由USB、DC Jack供電。
    + 目前遵照USB2.0的規格，電壓5[V]，最大電流500[mA]，最大功率2.5[W]。
    + 若使用行動電源，額定容量5[V]6500[mAh]，可使用至少13小時。
    + 若使用車用電池，額定容量12[V]45[Ah]，假設轉換效率普通為80%，則推測5[V]額定容量=(12/5)*45*80%=86.4[Ah]，約為5[V]86400[mAh]，至少可使用172小時(約7天)。
+ 儲存裝置:
  + 選用SD卡(Secure Digital Memory Card)，尺寸為microSD。目前市面上主流規範為SD3.0(SDXC)，最大容量可達2[TB]。讀寫速度遠大於我的資料量。
  + 檔案系統採用FAT32或exFAT:
    + FAT32，最大單一檔案容量=4[GB]，Windows下建議SD卡容量小於等於32[GB]的情況下使用此格式。讀寫速度較慢。
    + :heavy_check_mark:exFAT，最大單一檔案容量=64[ZB]。讀寫速度較快。
    + FAT32與exFAT使用相同的日期範圍，為1980年1月1日至2107年12月31日。
    + FAT32每個目錄下最大檔案數量理論上為65536個，但若開啟長檔名功能，則可用的數量會更少。
    + 儘管理論上各種檔案系統規範的理論數量都很高，在直接存取指定路徑時均不會有任何問題，但若要使用列舉或搜尋功能時則依賴相關的API函數，可能遇到該函數的上限或效率低下。
    + 建議每個資料夾內的檔案數量與子資料夾總數不超過2000個(子資料夾內的檔案與資料夾不計)。
  + 容量需求:
    + 每分鐘儲存在一個檔案中:
      + 保留1024[Bytes]作為檔頭。 
      + 8[ch]1000[Hz]24[bit]:
        + 每秒鐘容量=(8x1000x3)=24000[Bytes]。
        + 每分鐘容量=(8x1000x3x60)+1024=1441024[Bytes]=1408[KB]=1.375[MB]。
        + 每日容量=1980[MB]=2[GB]。
        + 使用標示256[GB]的SD卡，建議只使用90%的可用容量避免讀寫效率下降，約可使用(256x0.9)/2=115天(3個月多)。
        + 使用標示512[GB]的SD卡，建議只使用90%的可用容量避免讀寫效率下降，約可使用(512x0.9)/2=230天(半年多)。
        + 使用標示1[TB]=931[GB]的SD卡，建議只使用90%的可用容量避免讀寫效率下降，約可使用(931x0.9)/2=418天(1年多)。
      + :heavy_check_mark: 8[ch]100[Hz]24[bit]:
        + 每秒鐘容量=(8x100x3)=2400[Bytes]。
        + 每分鐘容量=(8x100x3x60)+1024=145024[Bytes]=142[KB]=0.14[MB]。
        + 每日容量=202[MB]。
        + :heavy_check_mark:使用標示256[GB]的SD卡，建議只使用90%的可用容量避免讀寫效率下降，約可使用(256x0.9)/0.202=1140天(3年多)。
        + 使用標示512[GB]的SD卡，建議只使用90%的可用容量避免讀寫效率下降，約可使用(512x0.9)/0.202=2281天(6年多)。
        + 使用標示1[TB]=931[GB]的SD卡，建議只使用90%的可用容量避免讀寫效率下降，約可使用(931x0.9)/0.202=4148天(11年多)。
      + 64[ch]10[Hz]24[bit]:
        + 每秒鐘容量=(64x10x3)=1920[Bytes]。
        + 每分鐘容量=(64x10x3x60)+1024=116224[Bytes]=114[KB]=0.112[MB]。
        + 每日容量=162[MB]。
        + 使用標示256[GB]的SD卡，建議只使用90%的可用容量避免讀寫效率下降，約可使用(256x0.9)/0.162=1422天(3年多)。
        + 使用標示512[GB]的SD卡，建議只使用90%的可用容量避免讀寫效率下降，約可使用(512x0.9)/0.162=2844天(7年多)。
        + 使用標示1[TB]=931[GB]的SD卡，建議只使用90%的可用容量避免讀寫效率下降，約可使用(931x0.9)/0.202=4148天(11年多)。
+ 即時傳輸:
  + 選用Ethernet (RJ45)，M487支援 10/100 Mbps乙太網MAC及RMII介面。
  + 採用UDP封包。受限於常見MTU=1500、1492，UDP扣掉封包頭的部分，封包內容最大約1450[Bytes]。這裡建議每個UDP封包長度不超過1250[Bytes]。
  + IP位置=??
  + 發送Port=???。
  + 發送目標IP=x.x.x.255
  + 內部網路使用，以來源IP、封包長度作為簡易校驗方式。因此各種傳輸內容將指定封包長度。
  + GPS message轉發:
    + NMEA 0183, version 4.0 
    + NMEA內容均為可見字元(不使用中文)，不固定長度，初步判斷長度不會大於150[Bytes]。
    + 規劃UDP_GPS_message封包長度=150[Bytes]。
    + 只轉發「$GNRMC」訊息。
    + 每秒轉發一次，在解析完命令後立刻轉發。
  + 起始時間轉發:
    + 內容均為可見文字(不使用中文)，遵守一層JSON格式(只有一組大括號)，即使是數字也使用字串型態。
    + 例如:「{"UDP_SN_START_TIME_UTC":"A00120230216141205"}」
    + 規劃UDP_START_TIME_UTC封包長度=46[Bytes]。
    + 每秒轉發一次，GPS message轉發完成後立刻轉發。 
  + 資料封包轉發:
    + 內容多數為二進為原始資料。
    + 8U8D_100版本:每秒發10次，間隔100[ms]，每次發送8頻道各10點(資料部分大小=8[ch]x3[bytes]x10[pts]=240[bytes])。
    + 檔頭包含索引值(Rasing Index與Failling Index)，索引值使用int32。

### 工作流程
+ 初始化:
  1. 上電。SD卡槽旁邊的LED燈(SD_POWER1)會亮。這是硬體過電就亮，非韌體控制。
  2. 初始化: 啟用Debug。
  3. 初始化: 測試LED燈(紅黃綠)。只能從外部觀看閃爍情況來驗證是否正常，軟體無法驗證。
  4. 初始化: 啟用SD卡功能。包含寫運行紀錄、讀取參數檔案。後續有需要可再寫入新參數檔案。
  5. 初始化: 啟用網路功能。包含設定MAC、IP、PORT等等。後續部分資訊同步從網路丟出。
  6. 初始化: 啟用ADS1256。包含硬體RESET、SPI溝通等等。
  7. 初始化: 啟用GPS模組。包含UART、TP1、TP2。注意，GPS參數已由u-center預先設定好並儲存在GPS模組內部。
+ 主迴圈:
  1. 定義GPS時間索引。
    + 已規劃:TP1=1[Hz]，length=3000[us]；TP2=100[Hz]，length=5000[us]。
    + 準備好TP1與TP2的中斷。
    + 開啟GPS電源。
    + 
  +
